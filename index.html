import express from 'express';
import cors from 'cors';
import axios from 'axios';
import path from 'path';

const app = express();
app.use(cors());
app.use(express.json());
app.use(express.static(process.cwd()));

// SUA CHAVE
const VIZZION_SECRET = 'e08f7qe1x8zjbnx4dkra9p8v7uj1wfacwidsnnf4lhpfq3v8oz628smahn8g6kus';
const API_URL = 'https://app.vizzionpay.com/api/v1/gateway/pix/receive';

app.post('/pix', async (req, res) => {
    console.log("--> NOVA TRANSAÇÃO (V10 - DOC OFICIAL)");

    try {
        let { valor, name, cpf, email } = req.body;

        // 1. DADOS PADRÃO
        if (!valor) valor = 27.90;
        const amountFloat = parseFloat(valor.toString()); // Garante que é número (Ex: 27.90)

        if (!name || name.length < 3) name = "Cliente Consumidor";
        if (!email) email = "cliente@pagamento.com";
        
        // Tratamento do CPF (apenas números)
        let cpfLimpo = cpf ? cpf.replace(/\D/g, '') : '';
        if (!cpfLimpo || cpfLimpo.length < 11) cpfLimpo = "05350974033"; // Genérico válido

        // 2. IDENTIFICADOR ÚNICO (OBRIGATÓRIO)
        const uniqueId = `PEDIDO-${Date.now()}-${Math.floor(Math.random() * 1000)}`;

        console.log(`Enviando: R$ ${amountFloat} | ID: ${uniqueId}`);

        // 3. ESTRUTURA EXATA DA DOCUMENTAÇÃO VIZZION
        const payloadVizzion = {
            identifier: uniqueId, 
            amount: amountFloat, // EM REAIS (NUMBER)
            client: {
                name: name,
                document: cpfLimpo,
                email: email,
                phone: "11999999999"
            },
            // Enviamos produtos para garantir que não recusem por falta de dados
            products: [
                {
                    name: "Taxa de Desbloqueio",
                    quantity: 1,
                    price: amountFloat
                }
            ]
        };

        // 4. CHAMADA API
        const response = await axios.post(API_URL, payloadVizzion, {
            headers: {
                'Authorization': `Bearer ${VIZZION_SECRET}`,
                'Content-Type': 'application/json'
            },
            timeout: 20000 
        });

        console.log("✅ VIZZION RESPONDEU 201:", JSON.stringify(response.data));

        const data = response.data;

        // 5. CAPTURA DO PIX NO RETORNO (OBJETO 'pix')
        // Segundo a doc, existe um objeto "pix" na resposta
        let copyPaste = "";
        let qrCodeImage = "";

        if (data.pix) {
            // Tenta pegar dentro do objeto pix
            copyPaste = data.pix.qrcode_text || data.pix.payload || data.pix.copy_paste || data.pix.emv;
            qrCodeImage = data.pix.qrcode_image || data.pix.qrcode || data.pix.base64 || data.pix.encodedImage;
        } 
        
        // Se não achou dentro de 'pix', tenta na raiz (fallback)
        if (!copyPaste) copyPaste = data.qrcode_text || data.pix_code || data.payload;
        if (!qrCodeImage) qrCodeImage = data.qrcode_image || data.encodedImage;

        return res.json({ success: true, payload: copyPaste, encodedImage: qrCodeImage });

    } catch (error: any) {
        console.error("❌ FALHA NA REQUISIÇÃO:");
        
        if (error.response) {
            // Erro detalhado da API (400, 401, etc)
            console.error(`Status: ${error.response.status}`);
            console.error(`Erro: ${JSON.stringify(error.response.data)}`);
            
            const msg = error.response.data.message || JSON.stringify(error.response.data);
            return res.json({ success: false, message: `Erro Vizzion: ${msg}` });
        } else {
            return res.json({ success: false, message: "Erro de conexão com a API." });
        }
    }
});

// Rota Principal
app.get('/', (req, res) => {
    res.sendFile(path.join(process.cwd(), 'index.html'));
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`SERVIDOR V10 RODANDO NA PORTA ${PORT}`));
