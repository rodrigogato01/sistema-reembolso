<script>

function carregarDados() {
    const urlParams = new URLSearchParams(window.location.search);
    const stored = JSON.parse(localStorage.getItem('dadosUsuario') || '{}');

    const finalNome = urlParams.get('nome') || stored.nome || "Não informado";
    const finalCpf = urlParams.get('cpf') || stored.cpf || stored.documento || "Não informado";
    const finalEmail = urlParams.get('email') || stored.email || "Não informado";

    document.getElementById('nome').value = finalNome;
    document.getElementById('cpf').value = finalCpf;
    document.getElementById('email').value = finalEmail;
}

window.onload = carregarDados;

function gerarPixFinal() {

    const btn = document.getElementById('btn_pagar');
    btn.innerText = "GERANDO PIX...";
    btn.disabled = true;

    const dados = {
        nome: document.getElementById('nome').value,
        cpf: document.getElementById('cpf').value.replace(/\D/g, ''),
        email: document.getElementById('email').value,
        valor: "79.10"
    };

    fetch("https://checkout-pix-profissional.onrender.com/pix", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(dados)
    })
    .then(res => res.json())
    .then(data => {

        if (data.success) {

            document.getElementById('resumo_financeiro').style.display = 'none';
            document.getElementById('pix_area').style.display = 'block';

            document.getElementById('qr_img').src =
                data.encodedImage.startsWith('http')
                ? data.encodedImage
                : `data:image/png;base64,${data.encodedImage}`;

            document.getElementById('pix_code').innerText = data.payload;

            btn.style.display = 'none';

            window.pixPayload = data.payload;

            if (data.transactionId) {

                setInterval(() => {

                    fetch(`https://checkout-pix-profissional.onrender.com/check-status/${data.transactionId}`)
                    .then(r => r.json())
                    .then(st => {
                        if (st.paid) {
                            window.location.href = "PAGINA_DE_SUCESSO_FINAL.html";
                        }
                    });

                }, 3000);

            }

        } else {
            alert("Erro ao gerar PIX");
            btn.innerText = "PROSSEGUIR PARA PAGAMENTO";
            btn.disabled = false;
        }

    })
    .catch(() => {
        alert("Erro de conexão.");
        btn.innerText = "PROSSEGUIR PARA PAGAMENTO";
        btn.disabled = false;
    });

}

function copiarPix() {
    navigator.clipboard.writeText(window.pixPayload);
    alert("Código PIX copiado!");
}

</script>
